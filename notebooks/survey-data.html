<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maja Čuljak">
<meta name="dcterms.date" content="2025-05-05">

<title>Data Science Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="survey-data_files/libs/clipboard/clipboard.min.js"></script>
<script src="survey-data_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="survey-data_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="survey-data_files/libs/quarto-html/popper.min.js"></script>
<script src="survey-data_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="survey-data_files/libs/quarto-html/anchor.min.js"></script>
<link href="survey-data_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="survey-data_files/libs/quarto-html/quarto-syntax-highlighting-53f539a478d6ecd1be31ce9fd30fd81c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="survey-data_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="survey-data_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="survey-data_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#tracking-data" id="toc-tracking-data" class="nav-link active" data-scroll-target="#tracking-data"><span class="header-section-number">1</span> Tracking data</a>
  <ul class="collapse">
  <li><a href="#available-tracking-data" id="toc-available-tracking-data" class="nav-link" data-scroll-target="#available-tracking-data"><span class="header-section-number">1.1</span> Available tracking data</a></li>
  <li><a href="#tracklabid-keyfile" id="toc-tracklabid-keyfile" class="nav-link" data-scroll-target="#tracklabid-keyfile"><span class="header-section-number">1.2</span> TrackLabID keyfile</a></li>
  </ul></li>
  <li><a href="#keyfiles" id="toc-keyfiles" class="nav-link" data-scroll-target="#keyfiles"><span class="header-section-number">2</span> Keyfiles</a>
  <ul class="collapse">
  <li><a href="#match-tracklab-ids" id="toc-match-tracklab-ids" class="nav-link" data-scroll-target="#match-tracklab-ids"><span class="header-section-number">2.1</span> Match TrackLab IDs</a></li>
  <li><a href="#consent" id="toc-consent" class="nav-link" data-scroll-target="#consent"><span class="header-section-number">2.2</span> Consent</a></li>
  </ul></li>
  <li><a href="#survey-scores" id="toc-survey-scores" class="nav-link" data-scroll-target="#survey-scores"><span class="header-section-number">3</span> Survey scores</a>
  <ul class="collapse">
  <li><a href="#teacher-responses" id="toc-teacher-responses" class="nav-link" data-scroll-target="#teacher-responses"><span class="header-section-number">3.1</span> Teacher responses</a>
  <ul class="collapse">
  <li><a href="#iop-scores" id="toc-iop-scores" class="nav-link" data-scroll-target="#iop-scores"><span class="header-section-number">3.1.1</span> IOP scores</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#temp-export-merged-file" id="toc-temp-export-merged-file" class="nav-link" data-scroll-target="#temp-export-merged-file"><span class="header-section-number">4</span> TEMP: Export merged file</a></li>
  <li><a href="#student-responses" id="toc-student-responses" class="nav-link" data-scroll-target="#student-responses"><span class="header-section-number">5</span> Student responses</a>
  <ul class="collapse">
  <li><a href="#align-student-responses-with-keyfiles" id="toc-align-student-responses-with-keyfiles" class="nav-link" data-scroll-target="#align-student-responses-with-keyfiles"><span class="header-section-number">5.1</span> Align student responses with keyfiles</a></li>
  <li><a href="#last-attempt-at-aligning-before-switching-to-manual" id="toc-last-attempt-at-aligning-before-switching-to-manual" class="nav-link" data-scroll-target="#last-attempt-at-aligning-before-switching-to-manual"><span class="header-section-number">5.2</span> Last attempt at aligning before switching to manual</a></li>
  <li><a href="#sparts-scores" id="toc-sparts-scores" class="nav-link" data-scroll-target="#sparts-scores"><span class="header-section-number">5.3</span> SPARTS scores</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Science Project</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Maja Čuljak </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 5, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="e4d2f7b2de23c373" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T20:36:07.598313Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T20:36:07.584059Z&quot;}}" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Had issues installing pyreadstat so used magic command in notebook instead</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># %pip install pyreadstat</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyreadstat</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="859e858140ec1c4a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T20:36:08.247326Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T20:36:08.244200Z&quot;}}" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish path to data folder</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> Path(<span class="st">'/Volumes/WRKGRP/STD-FSW-BSI-SD-Movement_Tracking/dsp/data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="tracking-data" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Tracking data</h1>
<section id="available-tracking-data" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="available-tracking-data"><span class="header-section-number">1.1</span> Available tracking data</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Only 2023 tracking data has been loaded since we do not have the survey responses to 2022 data.</p>
</div>
</div>
<div id="1c66ec8fd92936dd" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T20:40:03.660786Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T20:40:01.306732Z&quot;}}" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'tracking-data-all'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'02_interim'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>summary_filename <span class="op">=</span> <span class="st">'tracking-data-summary'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>summary_path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'02_interim'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>summary_filename<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># If files already exist, load them</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> path.exists() <span class="kw">and</span> summary_path.exists():</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Loaded file: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.csv'</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    tracking_data <span class="op">=</span> pd.read_csv(path).astype(<span class="bu">str</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    tracking_data[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(tracking_data[<span class="st">'date'</span>])</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Loaded file: </span><span class="sc">{</span>summary_filename<span class="sc">}</span><span class="ss">.csv'</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    tracking_summary <span class="op">=</span> pd.read_csv(summary_path).astype(<span class="bu">str</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    tracking_summary[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(tracking_summary[<span class="st">'date'</span>])    </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Else, create them from raw files</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get 2023 school/class info from tracking data subfolder names</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'01_tracking'</span> <span class="op">/</span> <span class="st">'2023'</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    subfolders <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> folder.iterdir() <span class="cf">if</span> f.is_dir()]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize list to store all tracking data entries</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    all_data <span class="op">=</span> []</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each subfolder</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subfolder <span class="kw">in</span> subfolders:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        date, school_num <span class="op">=</span> subfolder.split(<span class="st">'_s'</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        school_num, class_num <span class="op">=</span> school_num.split(<span class="st">'_c'</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the full path to the subfolder</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        subfolder_path <span class="op">=</span> folder <span class="op">/</span> subfolder</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find all CSV files in the subfolder</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        csv_files <span class="op">=</span> <span class="bu">list</span>(subfolder_path.glob(<span class="st">'*.csv'</span>))</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> csv_files:</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process each CSV file in the subfolder</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> csv_file <span class="kw">in</span> csv_files:</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                file_name <span class="op">=</span> csv_file.name</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract tracklab_id from filename by splitting on '] ' and taking the part after</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'] '</span> <span class="kw">in</span> file_name:</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>                    tracklab_id <span class="op">=</span> file_name.split(<span class="st">'] '</span>, <span class="dv">1</span>)[<span class="dv">1</span>]</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Remove .csv extension if present</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>                    tracklab_id <span class="op">=</span> tracklab_id.replace(<span class="st">'.csv'</span>, <span class="st">''</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Handle case where the expected delimiter isn't found</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>                    tracklab_id <span class="op">=</span> file_name.replace(<span class="st">'.csv'</span>, <span class="st">''</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add entry for this specific CSV file</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>                all_data.append([date, school_num, class_num, tracklab_id])</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no CSV files found, still add the folder info without tracklab_id</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            all_data.append([date, school_num, class_num, <span class="va">None</span>])</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create df with date, school, class, and tracklab_id</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    tracking_data <span class="op">=</span> pd.DataFrame(all_data, columns<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'tracklab_id'</span>])</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    tracking_data <span class="op">=</span> tracking_data.astype(<span class="bu">str</span>)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    tracking_data[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(tracking_data[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%Y_%m_</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create summary df of unique date, school, and class combinations</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    tracking_summary<span class="op">=</span> tracking_data[[<span class="st">'date'</span>, <span class="st">'school'</span>, <span class="st">'class'</span>]].drop_duplicates().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save dfs as csv</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    summary_filename <span class="op">=</span> <span class="st">'tracking-data-summary'</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    summary_path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'02_interim'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>summary_filename<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    summary_path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    tracking_summary.to_csv(summary_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Summary data saved to"</span>, summary_path)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    tracking_data.to_csv(path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"All data saved to"</span>, path)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>tracking_data.groupby([<span class="st">'date'</span>, <span class="st">'school'</span>, <span class="st">'class'</span>])[<span class="st">'tracklab_id'</span>].nunique().reset_index(name<span class="op">=</span><span class="st">'N tracklab_id'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded file: tracking-data-all.csv
Loaded file: tracking-data-summary.csv</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">N tracklab_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2023-04-11</td>
<td>42</td>
<td>102</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2023-05-11</td>
<td>43</td>
<td>103</td>
<td>30</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2023-05-23</td>
<td>46</td>
<td>107</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2023-05-24</td>
<td>47</td>
<td>108</td>
<td>15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2023-05-31</td>
<td>1</td>
<td>104</td>
<td>22</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2023-06-08</td>
<td>45</td>
<td>105</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2023-06-09</td>
<td>45</td>
<td>106</td>
<td>16</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="tracklabid-keyfile" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="tracklabid-keyfile"><span class="header-section-number">1.2</span> TrackLabID keyfile</h2>
<div id="ba2b2b1fd9ee4e11" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T20:40:46.825221Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T20:40:45.262065Z&quot;}}" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'keyfile_tracklab_id'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'02_interim'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> path.exists():</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load formatted keyfile</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Loaded file: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.csv'</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    keyfile_tagID <span class="op">=</span> pd.read_csv(path).astype(<span class="bu">str</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    display(keyfile_tagID)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and format raw keyfile + save </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    path_raw <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'keyfiles'</span> <span class="op">/</span> <span class="st">'Keyfile_csv.csv'</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    keyfile_tagID <span class="op">=</span> pd.read_csv(path_raw, delimiter<span class="op">=</span><span class="st">';'</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    keyfile_tagID <span class="op">=</span> keyfile_tagID.astype(<span class="bu">str</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    keyfile_tagID <span class="op">=</span> keyfile_tagID.rename(columns<span class="op">=</span>{<span class="st">'Tagnumber'</span>: <span class="st">'tagnumber'</span>, <span class="st">'TrackLabID'</span>: <span class="st">'tracklab_id'</span>})</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    keyfile_tagID.to_csv(path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Data saved to"</span>, path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded file: keyfile_tracklab_id.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">tagnumber</th>
<th data-quarto-table-cell-role="th">tracklab_id</th>
<th data-quarto-table-cell-role="th">subject_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0x24025F48A3E6</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>0x24025F48A133</td>
<td>nan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>0x24025F44F8D7</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>0x24046130B076</td>
<td>nan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>0x24046131F437</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">65</td>
<td>131</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">66</td>
<td>132</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">67</td>
<td>133</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">68</td>
<td>134</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">69</td>
<td>135</td>
<td>nan</td>
<td>nan</td>
</tr>
</tbody>
</table>

<p>70 rows × 3 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="keyfiles" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Keyfiles</h1>
<p>Keyfiles <strong>do not</strong> share the same structure. Columns containing tag numbers are called <code>tagnummer</code>, <code>tagnummer</code>, <code>tagnr</code>, etc. Teachers have not been added to the keyfiles according to an ID number; mostly they are denoted as ‘leerkracht’ in various columns.</p>
<p>Columns <code>sID_survey</code> and <code>ID_survey</code> have been added <strong>manually</strong> from the student response master sheet <code>TotalData_T1_all_cbs_ethnicity_gender.xlsx</code> after determining that the 4-digit ID numbers do not match across the individual keyfiles and master sheet, and aligning the data through code proved more time-consuming than copy/pasting.</p>
<p>Columns containing tag numbers have been merged into one column <code>tagnumber</code>.</p>
<p>Column <code>source</code> has been added to denote source file.</p>
<p>Column <code>comment</code> has been added as a container for any observations made in the classroom.</p>
<p>Teacher have been assigned their school, class, and placeholder ID numbers (9999).</p>
<div id="21e3efe198cfc75f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:19:30.455196Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:19:29.411212Z&quot;}}" data-execution_count="52">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>folder <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'keyfiles'</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initiate empty df</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>keyfiles <span class="op">=</span> pd.DataFrame()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading keyfiles...'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> folder.glob(<span class="st">'*.xlsx'</span>):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_excel(<span class="bu">file</span>, engine<span class="op">=</span><span class="st">'openpyxl'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'source'</span>] <span class="op">=</span> <span class="bu">file</span>.stem</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        keyfiles <span class="op">=</span> pd.concat([keyfiles, df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">file</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hidden Excel temp files can mess up the loop</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all entries to string</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>keyfiles <span class="op">=</span> keyfiles.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.<span class="bu">apply</span>(<span class="kw">lambda</span> y: <span class="bu">str</span>(<span class="bu">int</span>(y)) <span class="cf">if</span> pd.notna(y) <span class="kw">and</span> <span class="bu">isinstance</span>(y, (<span class="bu">float</span>, <span class="bu">int</span>)) <span class="cf">else</span> y))</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Example keyfile entries:'</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>keyfiles.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading keyfiles...
keyfile school 1 class 104.xlsx
keyfile school 41 class 100.xlsx
keyfile school 41 class 101.xlsx
keyfile school 42 class 102.xlsx
keyfile school 43 class 103.xlsx
keyfile school 45 class 105.xlsx
keyfile school 46 class 107.xlsx
keyfile school 45 class 106.xlsx
keyfile school 47 class 108.xlsx
Example keyfile entries:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school ID</th>
<th data-quarto-table-cell-role="th">klas ID</th>
<th data-quarto-table-cell-role="th">subject ID</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">voornaam</th>
<th data-quarto-table-cell-role="th">achternaam</th>
<th data-quarto-table-cell-role="th">consent</th>
<th data-quarto-table-cell-role="th">tagnummer</th>
<th data-quarto-table-cell-role="th">sID_survey</th>
<th data-quarto-table-cell-role="th">ID_survey</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">tagnr.</th>
<th data-quarto-table-cell-role="th">comment</th>
<th data-quarto-table-cell-role="th">tagnr</th>
<th data-quarto-table-cell-role="th">trackingnnumer</th>
<th data-quarto-table-cell-role="th">Unnamed: 11</th>
<th data-quarto-table-cell-role="th">tagnummer</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>44</td>
<td>104</td>
<td>1</td>
<td>2242</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>25</td>
<td>1</td>
<td>2204</td>
<td>keyfile school 1 class 104</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>44</td>
<td>104</td>
<td>2</td>
<td>2243</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>-</td>
<td>2</td>
<td>2206</td>
<td>keyfile school 1 class 104</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>44</td>
<td>104</td>
<td>3</td>
<td>2244</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>5</td>
<td>3</td>
<td>2207</td>
<td>keyfile school 1 class 104</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>44</td>
<td>104</td>
<td>4</td>
<td>2245</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>24</td>
<td>4</td>
<td>2208</td>
<td>keyfile school 1 class 104</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>44</td>
<td>104</td>
<td>5</td>
<td>2246</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>27</td>
<td>5</td>
<td>2209</td>
<td>keyfile school 1 class 104</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="f62ce020c5b06084" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:19:33.000865Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:19:32.965179Z&quot;}}" data-execution_count="53">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">### CREATE 'TAGNUMBER' COL</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column 'tagnumber' that combines all the tag number columns</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'tagnumber'</span>] <span class="op">=</span> keyfiles[<span class="st">'tagnummer'</span>].copy()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect column names</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print(keyfiles.columns)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create list of tag number columns</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>tag_columns <span class="op">=</span> [<span class="st">'tagnummer'</span>, <span class="st">'tagnummer '</span>, <span class="st">'tagnr.'</span>, <span class="st">'tagnr'</span>, <span class="st">'trackingnnumer'</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values in 'tagnumber' with values from other tag columns</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> tag_columns:</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'tagnummer'</span>:  <span class="co"># Skip the first column as we already copied it</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        keyfiles[<span class="st">'tagnumber'</span>] <span class="op">=</span> keyfiles[<span class="st">'tagnumber'</span>].fillna(keyfiles[col])</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop old tag number columns</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>keyfiles <span class="op">=</span> keyfiles.drop(columns<span class="op">=</span>tag_columns)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">### CREATE 'COMMENTS' COL</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the list of all columns in the DataFrame</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>all_columns <span class="op">=</span> keyfiles.columns.tolist()</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the indices of 'source' and 'tagnumber' columns</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>source_index <span class="op">=</span> all_columns.index(<span class="st">'source'</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>tagnumber_index <span class="op">=</span> all_columns.index(<span class="st">'tagnumber'</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>columns_between <span class="op">=</span> all_columns[source_index<span class="op">+</span><span class="dv">1</span>:tagnumber_index]</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack their entries in one series</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>fill_values <span class="op">=</span> keyfiles[columns_between].stack().groupby(level<span class="op">=</span><span class="dv">0</span>).first()</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Unify them in new column 'comment', then remove individual columns</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'comments'</span>] <span class="op">=</span> np.nan</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'comments'</span>] <span class="op">=</span> keyfiles[<span class="st">'comments'</span>].fillna(fill_values)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>keyfiles <span class="op">=</span> keyfiles.drop(columns <span class="op">=</span> columns_between)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Keyfile rows containing comments:'</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>keyfiles.loc[<span class="op">~</span>keyfiles[<span class="st">'comments'</span>].isna(), [<span class="st">'school ID'</span>, <span class="st">'klas ID'</span>, <span class="st">'subject ID'</span>, <span class="st">'comments'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Keyfile rows containing comments:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school ID</th>
<th data-quarto-table-cell-role="th">klas ID</th>
<th data-quarto-table-cell-role="th">subject ID</th>
<th data-quarto-table-cell-role="th">comments</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>41</td>
<td>100</td>
<td>8</td>
<td>Vragenlijst niet af kunnen ronden</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>41</td>
<td>100</td>
<td>9</td>
<td>Vragenlijst niet af kunnen ronden</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">37</td>
<td>41</td>
<td>100</td>
<td>21</td>
<td>sID duplicated in survey responses, both entri...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">38</td>
<td>41</td>
<td>100</td>
<td>22</td>
<td>Ziek</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>41</td>
<td>101</td>
<td>13</td>
<td>ziek</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">94</td>
<td>43</td>
<td>103</td>
<td>10</td>
<td>Vult vragenlijst niet in</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">128</td>
<td>45</td>
<td>105</td>
<td>10</td>
<td>it could be that not tag 12 but 30 was used fo...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">143</td>
<td>46</td>
<td>107</td>
<td>1</td>
<td>Ja</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">144</td>
<td>46</td>
<td>107</td>
<td>2</td>
<td>Ja, geen tracking</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">145</td>
<td>46</td>
<td>107</td>
<td>3</td>
<td>Nee</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">146</td>
<td>46</td>
<td>107</td>
<td>4</td>
<td>Onbekend</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">162</td>
<td>46</td>
<td>107</td>
<td>20</td>
<td>since student had no written consent, their na...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="8404c542ef6aa49c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:19:36.666037Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:19:36.630418Z&quot;}}" data-execution_count="54">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Clean tag numbers</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect values in tag number column</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles['tagnumber'].unique()</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Keep only rows containing digits in tag number column</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles = keyfiles[</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     keyfiles['tagnumber'].notna() &amp; </span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     keyfiles['tagnumber'].astype(str).str.isdigit()</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ]</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Inspect values in tag number again -&gt; OK</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles['tagnumber'].unique()</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">### RENAME COLS &amp; ADD DATES</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns for alignment</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>keyfiles <span class="op">=</span> keyfiles.rename(columns<span class="op">=</span>{<span class="st">'school ID'</span>: <span class="st">'school'</span>, <span class="st">'klas ID'</span>: <span class="st">'class'</span>, <span class="st">'id'</span>: <span class="st">'person_id'</span>, <span class="st">'subject ID'</span>: <span class="st">'subject_id'</span>})</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dates to keyfile by mapping</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'date'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>date_map <span class="op">=</span> tracking_data.set_index([<span class="st">'school'</span>, <span class="st">'class'</span>])[<span class="st">'date'</span>].to_dict()</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># # Update 'date' in keyfiles where keys match</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'date'</span>] <span class="op">=</span> keyfiles.<span class="bu">apply</span>(</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: date_map.get((row[<span class="st">'school'</span>], row[<span class="st">'class'</span>]), row[<span class="st">'date'</span>]),</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="match-tracklab-ids" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="match-tracklab-ids"><span class="header-section-number">2.1</span> Match TrackLab IDs</h2>
<div id="282ba5307e605f70" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:20:20.025212Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:20:19.994952Z&quot;}}" data-execution_count="57">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create mapping dictionary - convert keys to same type as keyfiles['tagnumber']</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tracklab_id_map <span class="op">=</span> keyfile_tagID.dropna(subset<span class="op">=</span>[<span class="st">'tagnumber'</span>]).set_index(<span class="st">'tagnumber'</span>)[<span class="st">'tracklab_id'</span>].to_dict()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Map values more efficiently using map() instead of apply</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'tracklab_id'</span>] <span class="op">=</span> keyfiles[<span class="st">'tagnumber'</span>].<span class="bu">map</span>(tracklab_id_map)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Example keyfile with tracklab ids included:'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>keyfiles[[<span class="st">'school'</span>, <span class="st">'class'</span>,<span class="st">'subject_id'</span>,<span class="st">'tracklab_id'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Example keyfile with tracklab ids included:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="57">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">tracklab_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>44</td>
<td>104</td>
<td>1</td>
<td>0x240461308FB5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>44</td>
<td>104</td>
<td>2</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>44</td>
<td>104</td>
<td>3</td>
<td>0x24046131F437</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>44</td>
<td>104</td>
<td>4</td>
<td>0x24025F44DBFA</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>44</td>
<td>104</td>
<td>5</td>
<td>0x24046131EE8C</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="consent" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="consent"><span class="header-section-number">2.2</span> Consent</h2>
<p>Column <code>consent</code> contains digits and commentary. Clear commentary such as ‘ja’ has been transformed into 1, denoting yes. Any entries <em>not</em> containing 1 in this column will not be taken into analysis.</p>
<div id="f8d67e6d3ea434d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:20:46.137245Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:20:46.109386Z&quot;}}" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect consent entries</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print('Entries in CONSENT:')</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print(keyfiles['consent'].unique())</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get position of 'source' column</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>source_position <span class="op">=</span> <span class="bu">list</span>(keyfiles.columns).index(<span class="st">'source'</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify columns before 'source'</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>cols_before_source <span class="op">=</span> keyfiles.columns[:source_position]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if any of these columns contain 'leerkracht'</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>has_leerkracht <span class="op">=</span> keyfiles[cols_before_source].<span class="bu">apply</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> col: col.astype(<span class="bu">str</span>).<span class="bu">str</span>.contains(<span class="st">'leerkracht'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>).<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign '9999' to 'subject_ID' where 'leerkracht' was found</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>keyfiles.loc[has_leerkracht, <span class="st">'subject_id'</span>] <span class="op">=</span> <span class="st">'9999'</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace positive non-digit consent entries with '1'</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'consent'</span>] <span class="op">=</span> keyfiles[<span class="st">'consent'</span>].replace(</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'ja'</span>: <span class="st">'1'</span>, <span class="st">'leerkracht'</span>: <span class="st">'1'</span>}</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect consent entries</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Entries in CONSENT:'</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(keyfiles[<span class="st">'consent'</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Entries in CONSENT:
['1' '4' '5' 'ja, geen tracking' nan 'Ja, geen tracking' '35'
 'received oral permission from parent on day of data collection']</code></pre>
</div>
</div>
</section>
</section>
<section id="survey-scores" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Survey scores</h1>
<section id="teacher-responses" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="teacher-responses"><span class="header-section-number">3.1</span> Teacher responses</h2>
<p>Teacher survey responses look like they were collected through an online form. Delivered raw as wide-format SPSS files.</p>
<p>School and class data has been added to each dataframe from source filename as a workaround because I was not able to determine which columns contained this data at first.</p>
<p>Based on reading the codebook and inspecting the answers in the raw files, I’ve determined the following:</p>
<ul>
<li>Q30 = school</li>
<li>Q31 = class</li>
<li>Q32 = ?</li>
<li>Q27 = T_gender</li>
<li>Q28 = T_age</li>
<li>Q29 = T_dutch</li>
<li>Q30.0 = T_exp1</li>
<li>Q31.0 = T_exp2</li>
<li>Q32.0 = T_time_teaching</li>
<li>Q33 = T_class_comp</li>
</ul>
<div id="4ab5c31f7f61c73f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:28:17.144012Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:27:59.529426Z&quot;}}" data-execution_count="60">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine path to raw SPSS files</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>folder <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'01_survey'</span> <span class="op">/</span> <span class="st">'teacher_raw_2023'</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initiate empty dict to store teacher questionnaire dfs</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>tq_all <span class="op">=</span> {}</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading teacher responses...'</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> folder.glob(<span class="st">'*.sav'</span>):</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    var_name <span class="op">=</span> <span class="bu">file</span>.stem</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_spss(<span class="bu">file</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add school/class as columns to each df from filename</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    school_num, class_num <span class="op">=</span> var_name.split(<span class="st">'_'</span>)[<span class="dv">1</span>:]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'school'</span>] <span class="op">=</span> school_num</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'class'</span>] <span class="op">=</span> class_num</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store df in dict with filename as key</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    tq_all[var_name] <span class="op">=</span> df</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>var_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Total dataframes: </span><span class="sc">{</span><span class="bu">len</span>(tq_all)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to inspect example of available columns</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># print(tq_all['tq_1_104'].columns.tolist())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading teacher responses...
tq_49_113
tq_1_104
tq_41_100
tq_41_101
tq_42_102
tq_43_103
tq_45_105
tq_45_106
tq_46_107
tq_47_108
tq_49_110
tq_49_111
tq_49_112
Total dataframes: 13</code></pre>
</div>
</div>
<div id="5036e2a2-5a5d-4e05-ab77-4a920b51d0ac" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-05T21:29:30.296046Z&quot;,&quot;start_time&quot;:&quot;2025-05-05T21:29:30.262309Z&quot;}}" data-execution_count="62">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initiate empty dict to store relevant tq only</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>tq_relevant <span class="op">=</span> {}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Finding teacher responses matching available tracking data...'</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> tq_all:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    school_num <span class="op">=</span> <span class="bu">str</span>(tq_all[df][<span class="st">'school'</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    class_num <span class="op">=</span> <span class="bu">str</span>(tq_all[df][<span class="st">'class'</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    tq_match <span class="op">=</span> tracking_data[</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        (tracking_data[<span class="st">'school'</span>] <span class="op">==</span> school_num) <span class="op">&amp;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        (tracking_data[<span class="st">'class'</span>] <span class="op">==</span> class_num)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tq_match.empty:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        tq_relevant[df] <span class="op">=</span> tq_all[df]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>df<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#todo concatenate AFTER the columns have been equalized</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># tq = pd.concat(tq_relevant, ignore_index=True)</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total matching: </span><span class="sc">{</span><span class="bu">len</span>(tq_relevant)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to inspect dataset</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># tq_relevant['tq_1_104']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Finding teacher responses matching available tracking data...
tq_1_104
tq_42_102
tq_43_103
tq_45_105
tq_45_106
tq_46_107
tq_47_108
Total matching: 7</code></pre>
</div>
</div>
<section id="iop-scores" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="iop-scores"><span class="header-section-number">3.1.1</span> IOP scores</h3>
<p>IOP response <code>Q68</code> is given per student. Variable name format is <code>Q68_N</code>, where N should match an entry in <code>keyfiles['subject ID']</code>. By matching the subject ID, <code>Q68</code> can then be matched to the 4-digit <code>ID</code> in the file containing student survey responses (once these have been fixed). For an initial analysis, the matching to the <code>subject ID</code> and thus to tracking tag numbers should be enough.</p>
<p>Confirmed with Nathalie that IOP responses were optional. If IOP response was given, variable <code>Q68</code> is followed by Q70 and Q71 with matching student number. <strong>We are only interested in Q68.</strong></p>
<ul>
<li>Q68 question: “In vergelijking met andere leerlingen bezoek ik [naam kind]”</li>
<li>Q68 responses: Minder vaak, Gemiddeld, Vaker</li>
</ul>
<div id="1dc976f988fae873" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T15:31:03.168819Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T15:31:03.081393Z&quot;}}" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Eliminate irrelevant columns in tq dataframes</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Lists of relevant questions</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>descriptives <span class="op">=</span> [<span class="st">'Q27'</span>, <span class="st">'Q28'</span>, <span class="st">'Q29'</span>, <span class="st">'Q30'</span>, <span class="st">'Q31'</span>, <span class="st">'Q32'</span>, <span class="st">'Q33'</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>iop_id <span class="op">=</span> [<span class="st">'Q68'</span>]  <span class="co"># Add 'Q70', 'Q71' for detailed IOP responses</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>tq_filtered <span class="op">=</span> {}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, df <span class="kw">in</span> tq_relevant.items():</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a mask for columns to keep</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    cols_to_keep <span class="op">=</span> []</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if column matches any descriptive column</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(q_id <span class="kw">in</span> col <span class="cf">for</span> q_id <span class="kw">in</span> descriptives):</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>            cols_to_keep.append(col)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if column contains any of the specified question IDs</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">any</span>(q_id <span class="kw">in</span> col <span class="cf">for</span> q_id <span class="kw">in</span> iop_id):</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            cols_to_keep.append(col)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new dataframe with only the columns to keep</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    tq_filtered[key] <span class="op">=</span> df[cols_to_keep]</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co">###Load IOP Q68 values into keyfiles df</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty column 'iop' in keyfiles</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'iop'</span> <span class="kw">not</span> <span class="kw">in</span> keyfiles.columns:</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    keyfiles[<span class="st">'iop'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through each df in the dict</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df_name, df <span class="kw">in</span> tq_filtered.items():</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Copy df to avoid pandas errors...</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    df_copy <span class="op">=</span> df.copy()</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert columns Q30 and Q31 to string</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    df_copy.loc[:, <span class="st">'Q30'</span>] <span class="op">=</span> df_copy[<span class="st">'Q30'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    df_copy.loc[:, <span class="st">'Q31'</span>] <span class="op">=</span> df_copy[<span class="st">'Q31'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify Q68_N columns</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    q68_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df_copy.columns <span class="cf">if</span> col.startswith(<span class="st">'Q68_'</span>)]</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through df rows</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> df_copy.iterrows():</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        school <span class="op">=</span> row[<span class="st">'Q30'</span>]</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        class_val <span class="op">=</span> row[<span class="st">'Q31'</span>]</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check each Q68_N column for matching subjects</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> q68_col <span class="kw">in</span> q68_cols:</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract N from Q68_N column name</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>            subject_id <span class="op">=</span> q68_col.split(<span class="st">'_'</span>)[<span class="dv">1</span>]</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get value from this Q68_N cell</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>            q68_value <span class="op">=</span> row[q68_col]</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only proceed if the cell has a valid value</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(q68_value) <span class="kw">and</span> <span class="bu">str</span>(q68_value) <span class="op">!=</span> <span class="st">"0"</span> <span class="kw">and</span> <span class="bu">str</span>(q68_value) <span class="op">!=</span> <span class="st">""</span>:</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Find matching rows in keyfiles where all three conditions are met</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>                matching_rows <span class="op">=</span> keyfiles[(keyfiles[<span class="st">'school'</span>] <span class="op">==</span> school) <span class="op">&amp;</span> </span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>                                        (keyfiles[<span class="st">'class'</span>] <span class="op">==</span> class_val) <span class="op">&amp;</span> </span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>                                        (keyfiles[<span class="st">'sID_survey'</span>] <span class="op">==</span> subject_id)]</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If matches found, update the 'iop' column with the actual value from Q68_N</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> matching_rows.empty:</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>                    keyfiles.loc[matching_rows.index, <span class="st">'iop'</span>] <span class="op">=</span> q68_value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="temp-export-merged-file" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> TEMP: Export merged file</h1>
<p>File includes connection school &amp; class -&gt; subject_id -&gt; tagnumber -&gt; tracklab_id + iop</p>
<div id="9a9f3b3e7834e21c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T15:31:47.741685Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T15:31:47.722318Z&quot;}}" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Temporarily rename school 1 to school 44 to match data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> tracking_data.copy().astype(<span class="bu">str</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>temp.loc[temp[<span class="st">'school'</span>]<span class="op">==</span><span class="st">'1'</span>, <span class="st">'school'</span>] <span class="op">=</span> <span class="st">'44'</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># temp[temp['school']=='44']</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#todo find out why school 44 has been (inconsistently) renamed school 1, and how we should call it</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the missing tracklab_ids for each school-class combination</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>missing_entries <span class="op">=</span> []</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique school-class combinations from keyfiles</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>school_class_combinations <span class="op">=</span> keyfiles[[<span class="st">'school'</span>, <span class="st">'class'</span>]].drop_duplicates()</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># For each school-class combination</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> school_class_combinations.iterrows():</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    school <span class="op">=</span> row[<span class="st">'school'</span>]</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    class_val <span class="op">=</span> row[<span class="st">'class'</span>]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all tracklab_ids for this school-class in tracking_data</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    tracking_ids <span class="op">=</span> temp[(temp[<span class="st">'school'</span>] <span class="op">==</span> school) <span class="op">&amp;</span> </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                        (temp[<span class="st">'class'</span>] <span class="op">==</span> class_val)][<span class="st">'tracklab_id'</span>].unique()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all tracklab_ids for this school-class already in keyfiles</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    keyfiles_ids <span class="op">=</span> keyfiles[(keyfiles[<span class="st">'school'</span>] <span class="op">==</span> school) <span class="op">&amp;</span> </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                           (keyfiles[<span class="st">'class'</span>] <span class="op">==</span> class_val)][<span class="st">'tracklab_id'</span>].unique()</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find tracklab_ids in tracking_data but not in keyfiles</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    missing_ids <span class="op">=</span> <span class="bu">set</span>(tracking_ids) <span class="op">-</span> <span class="bu">set</span>(keyfiles_ids)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create new rows for each missing tracklab_id</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> missing_id <span class="kw">in</span> missing_ids:</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a new row with school, class, and tracklab_id</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        new_row <span class="op">=</span> {</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'school'</span>: school,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'class'</span>: class_val,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tracklab_id'</span>: missing_id</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        missing_entries.append(new_row)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create df from the missing entries</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> missing_entries:</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    missing_df <span class="op">=</span> pd.DataFrame(missing_entries)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append missing entries to keyfiles</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    keyfiles <span class="op">=</span> pd.concat([keyfiles, missing_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Added </span><span class="sc">{</span><span class="bu">len</span>(missing_entries)<span class="sc">}</span><span class="ss"> new rows to keyfiles for missing tracklab_ids"</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"No missing tracklab_ids found."</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co">### EXPORT TO EXCEL</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>export <span class="op">=</span> keyfiles.loc[keyfiles[<span class="st">'school'</span>].isin(temp[<span class="st">'school'</span>].unique())]</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'merged-data-WIP'</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> pd.to_datetime(<span class="st">'today'</span>).strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">_%H-%M'</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>savepath <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'02_interim'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>today<span class="sc">}</span><span class="ss">.xlsx"</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>export.to_excel(savepath, index<span class="op">=</span><span class="va">False</span>, engine<span class="op">=</span><span class="st">'openpyxl'</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Display df</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>keyfiles.sort_values(by<span class="op">=</span>[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'tracklab_id'</span>])[[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'tracklab_id'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No missing tracklab_ids found</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">tracklab_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>41</td>
<td>100</td>
<td>0x24025F449A89</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>41</td>
<td>100</td>
<td>0x24025F44AD21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>41</td>
<td>100</td>
<td>0x24025F44DBFA</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>41</td>
<td>100</td>
<td>0x24025F44E6FB</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">35</td>
<td>41</td>
<td>100</td>
<td>0x24025F44ECCF</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">141</td>
<td>nan</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">163</td>
<td>nan</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">185</td>
<td>nan</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">206</td>
<td>nan</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">207</td>
<td>nan</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>247 rows × 3 columns</p>
</div>
</div>
</div>
</section>
<section id="student-responses" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Student responses</h1>
<div id="4c71a62cd06d4c03" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:26.070997Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:23.778460Z&quot;}}" data-execution_count="332">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">'TotalData_T1_all_cbs_ethnicity_gender'</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">'01_survey'</span> <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.xlsx"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>students_raw <span class="op">=</span> pd.read_excel(path)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>students <span class="op">=</span> students_raw.copy()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns to match keyfiles</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>students <span class="op">=</span> students.rename(columns<span class="op">=</span>{<span class="st">'School_ID'</span>: <span class="st">'school'</span>, <span class="st">'Class_ID'</span>: <span class="st">'class'</span>, <span class="st">'sID'</span>: <span class="st">'subject_id'</span>, <span class="st">'ID'</span>: <span class="st">'person_id'</span>}).astype(<span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8189b2a6720021e0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:26.074792Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:26.072526Z&quot;}}" data-execution_count="333">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn all columns before 'age' to string.</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This is totally arbitrary typecasting; I just need select columns in this range to be string.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get position of 'age' column</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># age_position = list(students.columns).index('age')</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Identify columns before 'age'</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># cols_before_age = students.columns[:age_position]</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Typecast to string</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># students[cols_before_age] = students[cols_before_age].astype('str')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="76338f7e1f22828c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:26.744251Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:26.741756Z&quot;}}" data-execution_count="334">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Create a set of valid (school, class) pairs from tracking_data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># valid_pairs = set(zip(tracking_data['school'], tracking_data['class']))</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Filter students DataFrame</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># students = students[</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     students.apply(lambda row: (row['school'], row['class']) in valid_pairs, axis=1)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="34ad1db4dfdc525c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:27.744850Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:27.742388Z&quot;}}" data-execution_count="335">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(students_raw.shape)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(students.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(310, 534)
(310, 534)</code></pre>
</div>
</div>
<div id="cbfca7c79008efd2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:28.184040Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:28.178554Z&quot;}}" data-execution_count="336">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create list of SPARTS score columns</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>st_rel <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> students_raw.columns <span class="cf">if</span> col.startswith(<span class="st">'st_rel'</span>)]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get index of 'gender_sr'</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>gender_sr_idx <span class="op">=</span> students.columns.get_loc(<span class="st">'gender_sr'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all columns up to and including 'gender_sr'</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>base_cols <span class="op">=</span> students.columns[:gender_sr_idx<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine with st_rel columns</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>students <span class="op">=</span> students[<span class="bu">list</span>(base_cols) <span class="op">+</span> st_rel]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="9283c9379de20cb" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:35.757695Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:35.730750Z&quot;}}" data-execution_count="337">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Discovered duplicate subject_id in raw student responses because my merge would not work, removing it now</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>duplicate <span class="op">=</span> students.loc[</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    (students.duplicated([<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>], keep<span class="op">=</span><span class="va">False</span>)) <span class="op">&amp;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    (students[<span class="st">'consent'</span>].astype(<span class="bu">str</span>)<span class="op">!=</span><span class="st">'1'</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>duplicate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="337">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">cohort</th>
<th data-quarto-table-cell-role="th">tracking</th>
<th data-quarto-table-cell-role="th">condition_seating</th>
<th data-quarto-table-cell-role="th">condition_game</th>
<th data-quarto-table-cell-role="th">nPupils</th>
<th data-quarto-table-cell-role="th">nAbsent</th>
<th data-quarto-table-cell-role="th">dataPresent</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">st_rel4</th>
<th data-quarto-table-cell-role="th">st_rel5</th>
<th data-quarto-table-cell-role="th">st_rel6</th>
<th data-quarto-table-cell-role="th">st_rel7</th>
<th data-quarto-table-cell-role="th">st_rel8</th>
<th data-quarto-table-cell-role="th">st_rel9</th>
<th data-quarto-table-cell-role="th">st_rel10</th>
<th data-quarto-table-cell-role="th">st_rel11</th>
<th data-quarto-table-cell-role="th">st_rel13</th>
<th data-quarto-table-cell-role="th">st_rel12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">114</td>
<td>1</td>
<td>41</td>
<td>100</td>
<td>2223</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>25</td>
<td>nan</td>
<td>0</td>
<td>...</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">128</td>
<td>1</td>
<td>41</td>
<td>100</td>
<td>2223</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>25</td>
<td>nan</td>
<td>0</td>
<td>...</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">238</td>
<td>1</td>
<td>45</td>
<td>105</td>
<td>2223</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>22</td>
<td>nan</td>
<td>0</td>
<td>...</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
<td>nan</td>
</tr>
</tbody>
</table>

<p>3 rows × 33 columns</p>
</div>
</div>
</div>
<div id="9f0bd9caad416379" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:41:37.524398Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:41:37.520818Z&quot;}}" data-execution_count="338">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>students <span class="op">=</span> students.drop(duplicate.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7b3932c340cfc60a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T13:55:41.474205Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T13:55:41.465928Z&quot;}}" data-execution_count="202">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>students_short <span class="op">=</span> students[[<span class="st">'school'</span>,<span class="st">'class'</span>,<span class="st">'tracking'</span>,<span class="st">'nPupils'</span>,<span class="st">'dataPresent'</span>,<span class="st">'person_id'</span>,<span class="st">'consent'</span>,<span class="st">'subject_id'</span>,<span class="st">'informed'</span>,<span class="st">'assent'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="align-student-responses-with-keyfiles" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="align-student-responses-with-keyfiles"><span class="header-section-number">5.1</span> Align student responses with keyfiles</h2>
<p>According to Nathalie, the order of the subject IDs (‘subjectID’) in the keyfiles are correct and can be matched to the student responses in the column ‘sID’. The 4-digit person ID numbers (‘id’) were noted down incorrectly in the keyfiles. They can be copied from the student responses, according to ‘sID’. – MC, 01-05-2025</p>
<div id="59cefe65977bd5be" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:33:59.785970Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:33:59.769217Z&quot;}}" data-execution_count="308">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, ensure the columns are standardized for proper matching</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>]:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to string, strip whitespace, and make lowercase to ensure matching</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    keyfiles[col] <span class="op">=</span> keyfiles[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.lower()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    students[col] <span class="op">=</span> students[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip().<span class="bu">str</span>.lower()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a composite key from the matching columns</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'match_key'</span>] <span class="op">=</span> keyfiles[<span class="st">'school'</span>] <span class="op">+</span> <span class="st">'|'</span> <span class="op">+</span> keyfiles[<span class="st">'class'</span>] <span class="op">+</span> <span class="st">'|'</span> <span class="op">+</span> keyfiles[<span class="st">'subject_id'</span>]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>students[<span class="st">'match_key'</span>] <span class="op">=</span> students[<span class="st">'school'</span>] <span class="op">+</span> <span class="st">'|'</span> <span class="op">+</span> students[<span class="st">'class'</span>] <span class="op">+</span> <span class="st">'|'</span> <span class="op">+</span> students[<span class="st">'subject_id'</span>]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dictionary mapping from match_key to person_id</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>person_id_map <span class="op">=</span> students.set_index(<span class="st">'match_key'</span>)[<span class="st">'person_id'</span>].to_dict()</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the mapping to keyfiles based on match_key</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'person_id'</span>] <span class="op">=</span> keyfiles[<span class="st">'match_key'</span>].<span class="bu">map</span>(person_id_map)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the temporary match_key column</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles.drop('match_key', axis=1, inplace=True)</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># students.drop('match_key', axis=1, inplace=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e8b05e34a26dc485" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>key</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="2f3d54d558d67990" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:17:57.610506Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:17:57.600912Z&quot;}}" data-execution_count="257">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change school 44 to 1 to match student response file</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>keyfiles.loc[keyfiles[<span class="st">'school'</span>]<span class="op">==</span><span class="st">'44'</span>, <span class="st">'school'</span>] <span class="op">=</span> <span class="st">'1'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7fdec865d0473973" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:29:52.392078Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:29:52.379865Z&quot;}}" data-execution_count="290">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prep for merge: typecast cols as str just in case</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # Convert relevant columns to string in both DataFrames</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]:</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    keyfiles.loc[:, col] <span class="op">=</span> keyfiles[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip()</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    students.loc[:, col] <span class="op">=</span> students[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.strip()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># merge_cols = ['school', 'class', 'subject_id', 'person_id']</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles[merge_cols] = keyfiles[merge_cols].astype('str')</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># students[merge_cols] = students[merge_cols].astype('str')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="75e7523ff5382623" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:29:54.014288Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:29:54.007959Z&quot;}}" data-execution_count="291">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge keyfiles and student response file</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>matched <span class="op">=</span> keyfiles.merge(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    students[[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]],</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>],</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">''</span>, <span class="st">'_new'</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite keyfiles['person_id'] with matches and assign NaN if no match</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles['person_id'] = matched['person_id_new']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f18e2a2dc61d9ee" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:34:18.023042Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:34:18.012599Z&quot;}}" data-execution_count="310">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> keyfiles[[<span class="st">'school'</span>,<span class="st">'class'</span>,<span class="st">'subject_id'</span>,<span class="st">'person_id'</span>, <span class="st">'consent'</span>]]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>temp</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># temp[temp['person_id_new'].isna()]</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># temp.loc[temp['person_id']!=temp['person_id_new']]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="310">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">person_id</th>
<th data-quarto-table-cell-role="th">consent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>47</td>
<td>108</td>
<td>1</td>
<td>2285</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>47</td>
<td>108</td>
<td>2</td>
<td>2286</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>47</td>
<td>108</td>
<td>3</td>
<td>2287</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>47</td>
<td>108</td>
<td>4</td>
<td>2288</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>47</td>
<td>108</td>
<td>5</td>
<td>2289</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">203</td>
<td>46</td>
<td>107</td>
<td>16</td>
<td>2278</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">204</td>
<td>46</td>
<td>107</td>
<td>17</td>
<td>2279</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">205</td>
<td>46</td>
<td>107</td>
<td>18</td>
<td>2280</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">206</td>
<td>46</td>
<td>107</td>
<td>19</td>
<td>2281</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">207</td>
<td>46</td>
<td>107</td>
<td>20</td>
<td>2283</td>
<td>received oral permission from parent on day of...</td>
</tr>
</tbody>
</table>

<p>208 rows × 5 columns</p>
</div>
</div>
</div>
<div id="5cb550f22a2c93c4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:34:58.638597Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:34:58.594467Z&quot;}}" data-execution_count="311">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug information to check matching problems</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> debug_matching():</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Function to help debug matching issues"""</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check where matches should happen but don't</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    keyfiles_sample <span class="op">=</span> keyfiles.head(<span class="dv">10</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sample keyfiles data:"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(keyfiles_sample[[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]])</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each row in sample, check if it should have matched</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> keyfiles_sample.iterrows():</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        match_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'school'</span>]<span class="sc">}</span><span class="ss">|</span><span class="sc">{</span>row[<span class="st">'class'</span>]<span class="sc">}</span><span class="ss">|</span><span class="sc">{</span>row[<span class="st">'subject_id'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        matches <span class="op">=</span> students_short[</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>            (students_short[<span class="st">'school'</span>] <span class="op">==</span> row[<span class="st">'school'</span>]) <span class="op">&amp;</span> </span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>            (students_short[<span class="st">'class'</span>] <span class="op">==</span> row[<span class="st">'class'</span>]) <span class="op">&amp;</span> </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>            (students_short[<span class="st">'subject_id'</span>] <span class="op">==</span> row[<span class="st">'subject_id'</span>])</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Checking row </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">, match_key: </span><span class="sc">{</span>match_key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(matches)<span class="sc">}</span><span class="ss"> matching rows in students_short"</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(matches) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Matching student data:"</span>)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(matches[[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]])</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment to run the debug function</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>debug_matching()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Sample keyfiles data:
  school class subject_id person_id
0     47   108          1      2285
1     47   108          2      2286
2     47   108          3      2287
3     47   108          4      2288
4     47   108          5      2289
5     47   108          6      2290
6     47   108          7      2291
7     47   108          8      2292
8     47   108          9      2293
9     47   108         10      2294

Checking row 0, match_key: 47|108|1
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
291     47   108          1      2285

Checking row 1, match_key: 47|108|2
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
292     47   108          2      2286

Checking row 2, match_key: 47|108|3
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
293     47   108          3      2287

Checking row 3, match_key: 47|108|4
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
294     47   108          4      2288

Checking row 4, match_key: 47|108|5
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
295     47   108          5      2289

Checking row 5, match_key: 47|108|6
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
296     47   108          6      2290

Checking row 6, match_key: 47|108|7
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
297     47   108          7      2291

Checking row 7, match_key: 47|108|8
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
298     47   108          8      2292

Checking row 8, match_key: 47|108|9
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
299     47   108          9      2293

Checking row 9, match_key: 47|108|10
Found 1 matching rows in students_short
Matching student data:
    school class subject_id person_id
300     47   108         10      2294</code></pre>
</div>
</div>
<div id="f7b177d5f0766635" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:39:31.197791Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:39:31.066739Z&quot;}}" data-execution_count="320">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># First reset the person_id column in keyfiles (if it already exists)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'person_id'</span> <span class="kw">in</span> keyfiles.columns:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    keyfiles[<span class="st">'person_id'</span>] <span class="op">=</span> np.nan</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the merge</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> keyfiles.merge(</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    students[[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]],</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>],</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    indicator<span class="op">=</span><span class="va">True</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Only use person_id values from the matches</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>keyfiles[<span class="st">'person_id'</span>] <span class="op">=</span> np.where(</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'_merge'</span>] <span class="op">==</span> <span class="st">'both'</span>,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'person_id'</span>],</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    np.nan</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/anaconda3/envs/dsp/lib/python3.11/site-packages/pandas/core/indexes/base.py:3805</span>, in <span class="ansi-cyan-fg">Index.get_loc</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg">   3804</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">3805</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span>._engine.get_loc(casted_key)
<span class="ansi-green-fg">   3806</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> err:

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">index.pyx:167</span>, in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">index.pyx:196</span>, in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi:7081</span>, in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi:7089</span>, in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

<span class="ansi-red-fg">KeyError</span>: 'person_id'

The above exception was the direct cause of the following exception:

<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[320]</span><span class="ansi-green-fg">, line 16</span>
<span class="ansi-green-fg">      6</span> merged = keyfiles.merge(
<span class="ansi-green-fg">      7</span>     students[[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">school</span><span class="ansi-yellow-fg">'</span>, <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">class</span><span class="ansi-yellow-fg">'</span>, <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">subject_id</span><span class="ansi-yellow-fg">'</span>, <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">person_id</span><span class="ansi-yellow-fg">'</span>]],
<span class="ansi-green-fg">      8</span>     on=[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">school</span><span class="ansi-yellow-fg">'</span>, <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">class</span><span class="ansi-yellow-fg">'</span>, <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">subject_id</span><span class="ansi-yellow-fg">'</span>],
<span class="ansi-green-fg">      9</span>     how=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">left</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">     10</span>     indicator=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">     11</span> )
<span class="ansi-green-fg">     13</span> <span style="font-style:italic;color:rgb(95,135,135)"># Only use person_id values from the matches</span>
<span class="ansi-green-fg">     14</span> keyfiles[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">person_id</span><span class="ansi-yellow-fg">'</span>] = np.where(
<span class="ansi-green-fg">     15</span>     merged[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">_merge</span><span class="ansi-yellow-fg">'</span>] == <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">both</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">16</span>     merged[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">person_id</span><span class="ansi-yellow-fg">'</span>],
<span class="ansi-green-fg">     17</span>     np.nan
<span class="ansi-green-fg">     18</span> )

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/anaconda3/envs/dsp/lib/python3.11/site-packages/pandas/core/frame.py:4102</span>, in <span class="ansi-cyan-fg">DataFrame.__getitem__</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg">   4100</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span>.columns.nlevels &gt; <span class="ansi-green-fg">1</span>:
<span class="ansi-green-fg">   4101</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span>._getitem_multilevel(key)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">4102</span> indexer = <span style="color:rgb(0,135,0)">self</span>.columns.get_loc(key)
<span class="ansi-green-fg">   4103</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> is_integer(indexer):
<span class="ansi-green-fg">   4104</span>     indexer = [indexer]

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/anaconda3/envs/dsp/lib/python3.11/site-packages/pandas/core/indexes/base.py:3812</span>, in <span class="ansi-cyan-fg">Index.get_loc</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg">   3807</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(casted_key, <span style="color:rgb(0,135,0)">slice</span>) <span style="font-weight:bold;color:rgb(175,0,255)">or</span> (
<span class="ansi-green-fg">   3808</span>         <span style="color:rgb(0,135,0)">isinstance</span>(casted_key, abc.Iterable)
<span class="ansi-green-fg">   3809</span>         <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">any</span>(<span style="color:rgb(0,135,0)">isinstance</span>(x, <span style="color:rgb(0,135,0)">slice</span>) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> x <span style="font-weight:bold;color:rgb(175,0,255)">in</span> casted_key)
<span class="ansi-green-fg">   3810</span>     ):
<span class="ansi-green-fg">   3811</span>         <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> InvalidIndexError(key)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">3812</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span>(key) <span style="font-weight:bold;color:rgb(0,135,0)">from</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">err</span>
<span class="ansi-green-fg">   3813</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">TypeError</span>:
<span class="ansi-green-fg">   3814</span>     <span style="font-style:italic;color:rgb(95,135,135)"># If we have a listlike key, _check_indexing_error will raise</span>
<span class="ansi-green-fg">   3815</span>     <span style="font-style:italic;color:rgb(95,135,135)">#  InvalidIndexError. Otherwise we fall through and re-raise</span>
<span class="ansi-green-fg">   3816</span>     <span style="font-style:italic;color:rgb(95,135,135)">#  the TypeError.</span>
<span class="ansi-green-fg">   3817</span>     <span style="color:rgb(0,135,0)">self</span>._check_indexing_error(key)

<span class="ansi-red-fg">KeyError</span>: 'person_id'</pre>
</div>
</div>
</div>
<div id="129df68a3820e41b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:37:56.153121Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:37:56.132543Z&quot;}}" data-execution_count="316">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>merged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="316">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">person_id_x</th>
<th data-quarto-table-cell-role="th">voornaam</th>
<th data-quarto-table-cell-role="th">achternaam</th>
<th data-quarto-table-cell-role="th">consent</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">tagnumber</th>
<th data-quarto-table-cell-role="th">comment</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">tracklab_id</th>
<th data-quarto-table-cell-role="th">match_key</th>
<th data-quarto-table-cell-role="th">person_id_y</th>
<th data-quarto-table-cell-role="th">_merge</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>47</td>
<td>108</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 47 class 108</td>
<td>9</td>
<td>NaN</td>
<td>2023-05-24</td>
<td>0x24046130C8AB</td>
<td>47|108|1</td>
<td>2285</td>
<td>both</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>47</td>
<td>108</td>
<td>2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 47 class 108</td>
<td>19</td>
<td>NaN</td>
<td>2023-05-24</td>
<td>0x24025F44AD21</td>
<td>47|108|2</td>
<td>2286</td>
<td>both</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>47</td>
<td>108</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 47 class 108</td>
<td>14</td>
<td>NaN</td>
<td>2023-05-24</td>
<td>0x24025F449A89</td>
<td>47|108|3</td>
<td>2287</td>
<td>both</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>47</td>
<td>108</td>
<td>4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 47 class 108</td>
<td>29</td>
<td>NaN</td>
<td>2023-05-24</td>
<td>0x24025F44CDE1</td>
<td>47|108|4</td>
<td>2288</td>
<td>both</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>47</td>
<td>108</td>
<td>5</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 47 class 108</td>
<td>28</td>
<td>NaN</td>
<td>2023-05-24</td>
<td>0x24025F4603F8</td>
<td>47|108|5</td>
<td>2289</td>
<td>both</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">205</td>
<td>46</td>
<td>107</td>
<td>16</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 46 class 107</td>
<td>25</td>
<td>NaN</td>
<td>2023-05-23</td>
<td>0x240461308FB5</td>
<td>46|107|16</td>
<td>2278</td>
<td>both</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">206</td>
<td>46</td>
<td>107</td>
<td>17</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 46 class 107</td>
<td>17</td>
<td>NaN</td>
<td>2023-05-23</td>
<td>0x24046131F062</td>
<td>46|107|17</td>
<td>2279</td>
<td>both</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">207</td>
<td>46</td>
<td>107</td>
<td>18</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>keyfile school 46 class 107</td>
<td>5</td>
<td>NaN</td>
<td>2023-05-23</td>
<td>0x24046131F437</td>
<td>46|107|18</td>
<td>2280</td>
<td>both</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">208</td>
<td>46</td>
<td>107</td>
<td>19</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>keyfile school 46 class 107</td>
<td>NaN</td>
<td>NaN</td>
<td>2023-05-23</td>
<td>NaN</td>
<td>46|107|19</td>
<td>2281</td>
<td>both</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">209</td>
<td>46</td>
<td>107</td>
<td>20</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>received oral permission from parent on day of...</td>
<td>keyfile school 46 class 107</td>
<td>9</td>
<td>since student had no written consent, their na...</td>
<td>2023-05-23</td>
<td>0x24046130C8AB</td>
<td>46|107|20</td>
<td>2283</td>
<td>both</td>
</tr>
</tbody>
</table>

<p>210 rows × 15 columns</p>
</div>
</div>
</div>
<div id="dd0fbbc4c0a87299" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T13:20:37.324990Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T13:20:37.315685Z&quot;}}" data-execution_count="115">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>keyfiles[[<span class="st">'school'</span>, <span class="st">'class'</span>,<span class="st">'subject_id'</span>, <span class="st">'person_id'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="115">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">person_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>47</td>
<td>108</td>
<td>1</td>
<td>2285</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>47</td>
<td>108</td>
<td>2</td>
<td>2286</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>47</td>
<td>108</td>
<td>3</td>
<td>2287</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>47</td>
<td>108</td>
<td>4</td>
<td>2288</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>47</td>
<td>108</td>
<td>5</td>
<td>2289</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">203</td>
<td>46</td>
<td>107</td>
<td>16</td>
<td>2277</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">204</td>
<td>46</td>
<td>107</td>
<td>17</td>
<td>2278</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">205</td>
<td>46</td>
<td>107</td>
<td>18</td>
<td>2279</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">206</td>
<td>46</td>
<td>107</td>
<td>19</td>
<td>2280</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">207</td>
<td>46</td>
<td>107</td>
<td>20</td>
<td>2281</td>
</tr>
</tbody>
</table>

<p>208 rows × 4 columns</p>
</div>
</div>
</div>
</section>
<section id="last-attempt-at-aligning-before-switching-to-manual" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="last-attempt-at-aligning-before-switching-to-manual"><span class="header-section-number">5.2</span> Last attempt at aligning before switching to manual</h2>
<div id="ef005c154749239b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:45:08.830384Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:45:08.812825Z&quot;}}" data-execution_count="340">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create deep copies of the dataframes to avoid modifying the originals</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>keyfiles_copy <span class="op">=</span> keyfiles.copy()</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>students_copy <span class="op">=</span> students.copy()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to thoroughly standardize data for matching</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_column(df, column):</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply comprehensive cleaning to ensure matching works"""</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="kw">in</span> df.columns:</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle different data types appropriately</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df[column].dtype.kind <span class="kw">in</span> <span class="st">'ifc'</span>:  <span class="co"># numeric columns</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert numeric to string without scientific notation</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            df[column] <span class="op">=</span> df[column].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">str</span>(<span class="bu">int</span>(x)) <span class="cf">if</span> pd.notnull(x) <span class="kw">and</span> <span class="bu">float</span>(x).is_integer() <span class="cf">else</span> </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>                                          (<span class="bu">str</span>(x) <span class="cf">if</span> pd.notnull(x) <span class="cf">else</span> np.nan))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For string/object columns</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            df[column] <span class="op">=</span> df[column].astype(<span class="bu">str</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply thorough cleaning</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        df[column] <span class="op">=</span> df[column].<span class="bu">str</span>.strip()</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        df[column] <span class="op">=</span> df[column].<span class="bu">str</span>.lower()</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove any non-visible characters</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        df[column] <span class="op">=</span> df[column].<span class="bu">str</span>.replace(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize unicode characters</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> unicodedata</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        df[column] <span class="op">=</span> df[column].<span class="bu">apply</span>(<span class="kw">lambda</span> x: unicodedata.normalize(<span class="st">'NFKD'</span>, x).encode(<span class="st">'ASCII'</span>, <span class="st">'ignore'</span>).decode() <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">str</span>) <span class="cf">else</span> x)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply standardization to both dataframes</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'school'</span>, <span class="st">'class'</span>, <span class="st">'subject_id'</span>]:</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keyfiles_copy = standardize_column(keyfiles_copy, col)</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    students_copy <span class="op">=</span> standardize_column(students_copy, col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="18e36fecbfed9b7b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:45:28.726085Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:45:28.607610Z&quot;}}">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative explicit approach using direct comparison and assignment</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> direct_matching_approach(keyfiles_df, students_df):</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Direct matching approach that ensures complete control over the matching process"""</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure person_id column exists in keyfiles</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'person_id'</span> <span class="kw">not</span> <span class="kw">in</span> keyfiles_df.columns:</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        keyfiles_df[<span class="st">'person_id'</span>] <span class="op">=</span> np.nan</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterate through each row in keyfiles</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, keyfile_row <span class="kw">in</span> keyfiles_df.iterrows():</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find matching rows in students_df</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        matches <span class="op">=</span> students_df[</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>            (students_df[<span class="st">'school'</span>] <span class="op">==</span> keyfile_row[<span class="st">'school'</span>]) <span class="op">&amp;</span> </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>            (students_df[<span class="st">'class'</span>] <span class="op">==</span> keyfile_row[<span class="st">'class'</span>]) <span class="op">&amp;</span> </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            (students_df[<span class="st">'subject_id'</span>] <span class="op">==</span> keyfile_row[<span class="st">'subject_id'</span>])</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If there's a match, use the person_id</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(matches) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>            keyfiles_df.at[idx, <span class="st">'person_id'</span>] <span class="op">=</span> matches.iloc[<span class="dv">0</span>][<span class="st">'person_id'</span>]</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> keyfiles_df</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co"># If the previous methods still don't work, try this direct approach</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>direct_result <span class="op">=</span> direct_matching_approach(keyfiles_copy, students_copy)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co"># keyfiles['person_id'] = direct_result['person_id']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="da976cadd8b5202c" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="83ebfce6dca917b5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-05-01T14:46:09.969810Z&quot;,&quot;start_time&quot;:&quot;2025-05-01T14:46:09.944186Z&quot;}}" data-execution_count="342">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> direct_result[[<span class="st">'school'</span>,<span class="st">'class'</span>,<span class="st">'subject_id'</span>,<span class="st">'person_id'</span>, <span class="st">'consent'</span>]]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>temp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="342">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">school</th>
<th data-quarto-table-cell-role="th">class</th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">person_id</th>
<th data-quarto-table-cell-role="th">consent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>47</td>
<td>108</td>
<td>1</td>
<td>2285</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>47</td>
<td>108</td>
<td>2</td>
<td>2286</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>47</td>
<td>108</td>
<td>3</td>
<td>2287</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>47</td>
<td>108</td>
<td>4</td>
<td>2288</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>47</td>
<td>108</td>
<td>5</td>
<td>2289</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">203</td>
<td>46</td>
<td>107</td>
<td>16</td>
<td>2278</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">204</td>
<td>46</td>
<td>107</td>
<td>17</td>
<td>2279</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">205</td>
<td>46</td>
<td>107</td>
<td>18</td>
<td>2280</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">206</td>
<td>46</td>
<td>107</td>
<td>19</td>
<td>2281</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">207</td>
<td>46</td>
<td>107</td>
<td>20</td>
<td>2283</td>
<td>received oral permission from parent on day of...</td>
</tr>
</tbody>
</table>

<p>208 rows × 5 columns</p>
</div>
</div>
</div>
</section>
<section id="sparts-scores" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="sparts-scores"><span class="header-section-number">5.3</span> SPARTS scores</h2>
<p>Source: https://doi.org/10.1111/bjep.12094</p>
<p>Relevant variables named ‘SPARTSN’ (e.g.&nbsp;‘SPARTS1’) in the codebook, but this name is not present in the data. Instead, variables named <strong>‘st_relN’</strong> have been identified as SPARTS scores. As explained in the codebook, the questionnaire contained 13 items, but Q13 was not presented to all students. After filtering the dataset for relevant data only (i.e., responses of students whose tracking data we have available), only responses 1-12 were available anyway.</p>
<p>Q12 is not part of the original scale, but developed for this study.</p>
<p>I cannot find a score sheet for this test that is not behind a paywall. The COTAN entry for the SPARTS lists a 25-item test instead of the 13-item test used.</p>
<p>#todo ask Yvonne &amp; Nathalie for scoring sheet</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>